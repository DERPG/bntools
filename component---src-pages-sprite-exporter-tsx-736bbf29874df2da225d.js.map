{"version":3,"sources":["webpack:///./node_modules/@babel/runtime/helpers/esm/assertThisInitialized.js","webpack:///./src/pages/sprite-exporter.tsx"],"names":["_assertThisInitialized","self","ReferenceError","Data","array","this","read8","address","read16","read32","DataReader","data","cursor","base","reset","newBase","newCursor","setCursor","ret","Frame","tilemap","palette","oams","Tilemap","tiles","OamSize","width","height","total","oamSizes","Palette","value","index","high","color","true","map","x","readTilemap","reader","tilesCount","Array","i","tile","byte","first","second","readPalette","readOams","start","startTile","offsetX","offsetY","size","shape","oam","push","SpriteExporter","props","state","image","canvasRef","React","createRef","loadFile","bind","load","readSprite","event","console","log","FileReader","readAsArrayBuffer","target","files","onloadend","ev","Uint8Array","result","canvas","current","ctx","getContext","clearRect","animationCount","animationPointers","frames","tilemapPointer","palettePointer","oamPointer","forEach","frame","f","tox","toy","y","t","canvasX","canvasY","Math","floor","imageData","getImageData","bi","pi","putImageData","render","type","onChange","defaultValue","ref","Component"],"mappings":"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","file":"component---src-pages-sprite-exporter-tsx-736bbf29874df2da225d.js","sourcesContent":["export default function _assertThisInitialized(self) {\n  if (self === void 0) {\n    throw new ReferenceError(\"this hasn't been initialised - super() hasn't been called\");\n  }\n\n  return self;\n}","import React, { ChangeEvent } from \"react\"\n\nclass Data {\n  private array: Uint8Array;\n\n  constructor(array: Uint8Array) {\n    this.array = array;\n  }\n\n  read8(address): number {\n    return this.array[address];\n  }\n\n  read16(address): number {\n    return this.array[address] + (this.array[address + 1] << 8);\n  }\n\n  read32(address): number {\n    return this.array[address] + (this.array[address + 1] << 8) + (this.array[address + 2] << 16) + (this.array[address + 3] << 24);\n  }\n}\n\nclass DataReader {\n  private data: Data;\n  private cursor: number;\n  private base: number;\n\n  constructor(data: Data) {\n    this.data = data;\n    this.cursor = 0;\n    this.base = 0;\n  }\n\n  reset(newBase: number, newCursor: number): void {\n    this.base = newBase;\n    this.cursor = newCursor;\n  }\n\n  setCursor(newCursor: number): void {\n    this.cursor = newCursor;\n  }\n\n  read8(): number {\n    const ret = this.data.read8(this.base + this.cursor);\n    this.cursor += 1;\n    return ret;\n  }\n\n  read16(): number {\n    const ret = this.data.read16(this.base + this.cursor);\n    this.cursor += 2;\n    return ret;\n  }\n\n  read32(): number {\n    const ret = this.data.read32(this.base + this.cursor);\n    this.cursor += 4;\n    return ret;\n  }\n}\n\nclass Sprite {\n  animations: Animation[];\n}\n\nclass Animation {\n  frames: Frame[];\n}\n\nclass Frame {\n  tilemap: Tilemap;\n  palette: Palette;\n  oams: Oam[];\n\n  constructor(tilemap: Tilemap, palette: Palette, oams: Oam[]) {\n    this.tilemap = tilemap;\n    this.palette = palette;\n    this.oams = oams;\n  }\n}\n\nclass Tilemap {\n  tiles: number[][];\n\n  constructor(tiles: number[][]) {\n    this.tiles = tiles;\n  }\n}\n\nclass OamSize {\n  width: number;\n  height: number;\n\n  constructor(width: number, height: number) {\n    this.width = width;\n    this.height = height;\n  }\n\n  total() {\n    return this.width * this.height;\n  }\n}\n\nconst oamSizes: OamSize[] = [\n  new OamSize(1, 1),\n  new OamSize(2, 2),\n  new OamSize(4, 4),\n  new OamSize(8, 8),\n  new OamSize(2, 1),\n  new OamSize(4, 1),\n  new OamSize(4, 2),\n  new OamSize(8, 2),\n  new OamSize(1, 2),\n  new OamSize(1, 4),\n  new OamSize(2, 4),\n  new OamSize(4, 8)\n];\n\ninterface Oam {\n  startTile: number;\n  offsetX: number;\n  offsetY: number;\n  size: OamSize;\n}\n\nclass Palette {\n  private array: any;\n\n  constructor(array: any) {\n    this.array = array;\n  }\n\n  value(index): number {\n    return this.array[index];\n  }\n\n  high(index): number[] {\n    const color = this.value(index);\n    const r = color & 0x1f;\n    const g = (color & 0x3e0) >> 5;\n    const b = (color & 0x7c00) >> 10;\n    return [r, g, b];\n  }\n\n  true(index): number[] {\n    return this.high(index).map(x => x * 8);\n  }\n}\n\nfunction toHex(value: number): string {\n  return value.toString(16);\n}\n\nfunction readSprite(data: Data, address: number): Frame[] {\n  const cursor = new DataReader(data);\n  cursor.setCursor(address);\n\n  cursor.read8();\n  cursor.read8(); // 0x00\n  cursor.read8(); // 0x01\n  const animationCount = cursor.read8();\n  \n  const animationPointers = new Array(animationCount);\n  const animations = new Array(animationCount);\n  const frames = new Array(256);\n\n  cursor.reset(address + 0x04, 0x00);\n\n  for (let i = 0; i < animationCount; i++) {\n    animationPointers[i] = cursor.read32();\n  }\n\n  for (let i = 0; i < animationCount; i++) {\n    cursor.setCursor(animationPointers[i]);\n    const tilemapPointer = cursor.read32();\n    const palettePointer = cursor.read32();\n    const ptr3 = cursor.read32();\n    const oamPointer = cursor.read32();\n    const animationDelay = cursor.read8();\n    cursor.read8(); // 0x00\n    const end = cursor.read8();\n    cursor.read8(); // 0x00\n\n    cursor.setCursor(tilemapPointer);\n    const tilemap = readTilemap(cursor);\n\n    cursor.setCursor(palettePointer);\n    const palette = readPalette(cursor);\n\n    cursor.setCursor(oamPointer);\n    const oams = readOams(cursor);\n\n    frames[i] = new Frame(tilemap, palette, oams);\n  }\n\n  return frames;\n}\n\nfunction readTilemap(reader: DataReader): Tilemap {\n  const size = reader.read32();\n  const tilesCount = size / 0x20; // 0x20 is the byte size of an 8x8 tile == 32 bytes\n  const tiles = new Array(tilesCount);\n\n  for (let i = 0; i < tilesCount; i++) {\n    // read a tile\n    const tile = new Array(64); // for convenience we're unpacking the bits\n    for (let i = 0; i < 0x20; i++) {\n      const byte = reader.read8();\n      const first = byte & 0x0f;\n      const second = (byte & 0xf0) >> 4;\n      tile[i*2] = first;\n      tile[i*2+1] = second;\n    }\n    tiles[i] = tile;\n  }\n\n  return new Tilemap(tiles);\n}\n\nfunction readPalette(reader: DataReader): Palette {\n  const size = reader.read32(); // always 0x20 == 32 bytes. 2 bytes per entry\n  const palette = new Array(16);\n\n  for (let i = 0; i < 16; i++) {\n    palette[i] = reader.read16();\n  }\n\n  return new Palette(palette);\n}\n\nfunction readOams(reader: DataReader): Oam[] {\n  const oams: Oam[] = [];\n  const start = reader.read32() - 4;\n\n  // skip enough bytes\n  for (let i = 0; i < start; i++) {\n    reader.read8();\n  }\n\n  while (true) {\n    const startTile = reader.read8();\n    const offsetX = reader.read8();\n    const offsetY = reader.read8();\n    const size = reader.read8();\n    const shape = reader.read8();\n\n    if (startTile === 0xff && offsetX === 0xff && offsetY === 0xff && size === 0xff && shape === 0xff) {\n      break;\n    }\n\n    const oamSize = oamSizes[((shape & 0x3) << 2) + (size & 0x3)];\n\n    const oam: Oam = {\n      startTile,\n      offsetX,\n      offsetY,\n      size: oamSize\n    };\n\n    oams.push(oam);\n  }\n\n  return oams;\n}\n\nclass SpriteExporter extends React.Component {\n  private canvasRef: React.RefObject<HTMLCanvasElement>;\n  private data: Data;\n\n  constructor(props) {\n    super(props);\n    this.state = {\n      image: null\n    };\n\n    this.canvasRef = React.createRef();\n\n    this.loadFile = this.loadFile.bind(this);\n    this.load = this.load.bind(this);\n    this.readSprite = this.readSprite.bind(this);\n  }\n\n  loadFile(event: ChangeEvent<HTMLInputElement>) {\n    console.log('loaded file');\n\n    const reader = new FileReader();\n    reader.readAsArrayBuffer(event.target.files[0]);\n    reader.onloadend = (ev) => {\n      const array = new Uint8Array(ev.target.result as ArrayBuffer);\n      const data = new Data(array);\n      this.data = data;\n\n      this.load(0x3bf284);\n    };\n  }\n\n  load(address: number) {\n    const canvas = this.canvasRef.current;\n    const ctx = canvas.getContext('2d');\n    ctx.clearRect(0, 0, canvas.width, canvas.height);\n\n    const frames = readSprite(this.data, address);\n\n    frames.forEach((frame, f) => {\n      // frame.tilemap.tiles.forEach((tile, xi) => {\n      //   const imageData = ctx.getImageData(xi * 8, y * 8, 8, 8);\n      //   const palette = frame.palette;\n        // for (let p = 0; p < 64; p++) {\n        //   const bi = p * 4;\n        //   const color = palette.true(tile[p]);\n        //   imageData.data[bi] = color[0];\n        //   imageData.data[bi+1] = color[1];\n        //   imageData.data[bi+2] = color[2];\n        //   imageData.data[bi+3] = 0xff;\n        // }\n\n      //   ctx.putImageData(imageData, xi * 8, y * 8);\n      // });\n\n      const palette = frame.palette;\n\n      frame.oams.forEach((oam) => {\n        console.log(oam);\n        let tox = 0;\n        let toy = 0;\n\n        let x = 0, y = 0;\n        if (oam.offsetX <= 0x7f) {\n          x = 128 + oam.offsetX;\n        } else {\n          x = oam.offsetX - 128;\n        }\n\n        console.log(x);\n\n        if (oam.offsetY <= 0x7f) {\n          y = 128 + oam.offsetY;\n        } else {\n          y = oam.offsetY - 128;\n        }\n\n        for (let t = 0; t < oam.size.total(); t++) {\n          const tile = oam.startTile + t;\n          const canvasX = x + tox * 8 + (f % 8) * 64;\n          const canvasY = Math.floor(f / 8) * 64 + y + toy * 8;\n          const imageData = ctx.getImageData(canvasX, canvasY, 8, 8);\n\n          for (let i = 0; i < 64; i++) {\n            const bi = i * 4;\n            const pi = frame.tilemap.tiles[tile][i];\n            if (pi !== 0) {\n              const color = palette.true(pi);\n              imageData.data[bi] = color[0];\n              imageData.data[bi+1] = color[1];\n              imageData.data[bi+2] = color[2];\n              imageData.data[bi+3] = 0xff;\n            }\n          }\n\n          ctx.putImageData(imageData, canvasX, canvasY);\n\n          tox ++;\n          if (tox >= oam.size.width) {\n            toy ++;\n            tox = 0;\n          }\n      }\n      });\n\n    });\n  }\n\n  readSprite(event) {\n    const value = event.target.value;\n    const address = this.data.read32(0x31ea8 + value * 4) & 0xffffff;\n\n    this.load(address);\n  }\n\n  render() {\n    return (\n      <div>\n        <h2>Sprite exporter</h2>\n        <input type=\"file\" onChange={this.loadFile} />\n        <input type=\"number\" onChange={this.readSprite} defaultValue={0} />\n        <canvas ref={this.canvasRef} width={8 * 128} height={8 * 64} />\n      </div>\n    );\n  }\n}\n\nexport default SpriteExporter;\n"],"sourceRoot":""}